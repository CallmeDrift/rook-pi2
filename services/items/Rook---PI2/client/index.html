<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo Subastas</title>
  <script type="module">
    import { io } from "https://cdn.socket.io/4.8.1/socket.io.esm.min.js";
    const socket = io();

    // Helpers
    const log = (text) => {
      const li = document.createElement("li");
      li.textContent = text;
      document.getElementById("log").appendChild(li);
    };

    // === Notificaciones en tiempo real ===
    socket.on("notification", (n) => {
      log(`[notif] ${n.message} (to: ${n.userId})`);
    });

    let lastAuctionId = '';
  let detailTimer = null; // servidor (ya no usado para polling)
  let detailUiTimer = null; // timer local para countdown UI
  let detailEndsAtIso = null;

    const setLastAuctionId = (id) => {
      lastAuctionId = id;
      document.getElementById("bid-auction").value = id;
      document.getElementById("bn-auction").value = id;
      document.getElementById("detail-auction").value = id;
    };

    function startDetailCountdown() {
      if (detailUiTimer) { clearInterval(detailUiTimer); detailUiTimer = null; }
      if (!detailEndsAtIso) return;
      const update = () => {
        const diff = Math.max(0, new Date(detailEndsAtIso).getTime() - Date.now());
        const hrs = Math.floor(diff / 3_600_000);
        const el = document.getElementById("detail-countdown");
        if (el) el.textContent = `${hrs} h`;
      };
      update();
      detailUiTimer = setInterval(update, 60_000);
    }

    async function fetchAndRenderDetail(userId, auctionId) {
      const resp = await fetch(`/api/auctions/${auctionId}`, { headers: { "x-user-id": userId } });
      const data = await resp.json();
      if (!resp.ok) { log(`Error: ${data.error}`); return; }
      const out = document.getElementById("detail-out");
      const reviews = Array.isArray(data.reviews) ? data.reviews : [];
      const reviewsHtml = reviews.length
        ? `<ul style=\"margin:6px 0;padding-left:18px\">${reviews.map(r => `
            <li>
              <b>${'★'.repeat(Math.max(0, Math.min(5, Number(r.rating) || 0)))}</b>
              <span style=\"margin-left:6px\">${r.comment ?? ''}</span>
              <small style=\"color:#666;margin-left:6px\">por ${r.userId}</small>
            </li>`).join('')}</ul>`
        : `<div style=\"color:#666\"><i>Sin valoraciones aún.</i></div>`;
      out.innerHTML = `
        <div><b>ID:</b> ${auctionId}</div>
        <div><b>Estado:</b> ${data.auction.status}</div>
        <div><b>Duración:</b> ${data.durationHours} h</div>
        <div><b>Cuenta regresiva:</b> <span id="detail-countdown">${data.timeRemainingHours} h</span></div>
        <div><b>Precio actual:</b> ${data.currentBid}</div>
        <div><b>BuyNow:</b> ${data.auction.buyNowPrice ?? "-"}</div>
        <div style=\"margin-top:8px\"><b>Valoraciones (${reviews.length}):</b></div>
        ${reviewsHtml}
      `;

      // Guardar endsAt y activar contador local sin llamadas al servidor
      detailEndsAtIso = data.auction.endsAt;
      startDetailCountdown();
    }

    // === Crear subasta ===
    document.getElementById("create-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const userId = document.getElementById("create-user").value.trim();
      const itemId = document.getElementById("create-item").value.trim();
      const startingPrice = Number(document.getElementById("create-price").value);
      const durationHours = Number(document.getElementById("create-duration").value);
      const buyNowPrice = Number(document.getElementById("create-bn").value);

      const resp = await fetch("/api/auctions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-user-id": userId,
        },
        body: JSON.stringify({ itemId, startingPrice, durationHours, buyNowPrice }),
      });

      const data = await resp.json();
      if (resp.ok) {
        const id = data.auction.id;
        setLastAuctionId(id);
        log(`Subasta creada: ${id} (duración ${data.auction.durationHours ?? durationHours}h)`);
        // mostrar detalle al crear
        const detailUser = document.getElementById("detail-user").value.trim() || userId;
        document.getElementById("detail-user").value = detailUser;
        await fetchAndRenderDetail(detailUser, id);
      } else {
        log(`Error: ${data.error}`);
      }
    });

    // === Pujar ===
    document.getElementById("bid-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const userId = document.getElementById("bid-user").value.trim();
      const auctionId = document.getElementById("bid-auction").value.trim();
      const amount = Number(document.getElementById("bid-amount").value);

      const resp = await fetch(`/api/auctions/${auctionId}/bids`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-user-id": userId,
        },
        body: JSON.stringify({ amount }),
      });

      const data = await resp.json();
      log(resp.ok ? `Puja OK en ${auctionId}: ${amount}` : `Error: ${data.error}`);
    });

    // === Buy-now ===
    document.getElementById("bn-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const userId = document.getElementById("bn-user").value.trim();
      const auctionId = document.getElementById("bn-auction").value.trim();

      const resp = await fetch(`/api/auctions/${auctionId}/buy-now`, {
        method: "POST",
        headers: { "x-user-id": userId },
      });

      const data = await resp.json();
      log(resp.ok ? `Buy-now OK en ${auctionId}` : `Error: ${data.error}`);
    });

    // === Detalle de subasta (muestra duración y countdown redondeado) ===
    document.getElementById("detail-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const userId = document.getElementById("detail-user").value.trim();
      const auctionId = document.getElementById("detail-auction").value.trim();
      await fetchAndRenderDetail(userId, auctionId);
      log(`Detalle mostrado para ${auctionId}`);
    });

  // Eliminado el auto-refresh de servidor; el contador ahora es local con endsAt
  </script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Ubuntu;margin:0;padding:20px;display:flex;gap:20px}
    section{border:1px solid #ccc;border-radius:8px;padding:12px;flex:1;min-width:280px}
    h2{margin-top:0}
    form{display:flex;flex-direction:column;gap:6px}
    input,select,button{padding:6px;border:1px solid #aaa;border-radius:4px}
    button{background:#09f;color:#fff;cursor:pointer}
    button:hover{background:#0cf}
    #log{list-style:none;padding:0;max-height:300px;overflow:auto;background:#f7f7f7}
    #log li{padding:4px 6px;border-bottom:1px solid #ddd;font-size:14px}
  </style>
</head>
<body>
  <!-- Crear -->
  <section>
    <h2>Crear subasta</h2>
    <form id="create-form">
      <input id="create-user" placeholder="UserId (ej. user-1)" required />
      <input id="create-item" placeholder="ItemId" required />
      <input id="create-price" type="number" placeholder="Precio inicial" required />
      <select id="create-duration">
        <option value="24">24h</option>
        <option value="48">48h</option>
      </select>
      <input id="create-bn" type="number" placeholder="BuyNow opcional" />
      <button>Crear</button>
    </form>
  </section>

  <!-- Pujar -->
  <section>
    <h2>Pujar</h2>
    <form id="bid-form">
      <input id="bid-user" placeholder="UserId (ej. user-2)" required />
      <input id="bid-auction" placeholder="AuctionId" required />
      <input id="bid-amount" type="number" placeholder="Monto" required />
      <button>Pujar</button>
    </form>
  </section>

  <!-- Buy-now -->
  <section>
    <h2>Buy-now</h2>
    <form id="bn-form">
      <input id="bn-user" placeholder="UserId (ej. user-1)" required />
      <input id="bn-auction" placeholder="AuctionId" required />
      <button>Comprar</button>
    </form>
  </section>

  <!-- Log -->
  <section>
    <h2>Log</h2>
    <ul id="log"></ul>
  </section>

  <!-- Detalle -->
  <section>
    <h2>Detalle de subasta</h2>
    <form id="detail-form">
      <input id="detail-user" placeholder="UserId (ej. user-1)" required />
      <input id="detail-auction" placeholder="AuctionId" required />
      <button>Ver detalle</button>
    </form>
    <div id="detail-out" style="margin-top:8px;font-size:14px"></div>
  </section>
</body>
</html>
